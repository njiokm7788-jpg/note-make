# 反向遮罩叠加模式 - 综合分析报告

## 项目概述

**目标**: 重构图片处理逻辑，实现反向遮罩叠加模式
- 使用清晰原图检测文字区域
- 在带笔记的模糊图片对应位置添加色块
- 合成"清晰字体+笔记"的结果图片

**技术栈**: React 19 + TypeScript + Canvas API + Tailwind CSS

---

## 综合决策汇总

| 决策项 | 最终选择 | 来源 |
|--------|----------|------|
| 架构策略 | 移除现有功能，完全重写 | 用户确认 |
| 检测算法 | 亮度阈值检测 | 用户确认 + 算法专家 |
| 遮罩膨胀 | 简单圆形膨胀（移除边缘引导） | 系统架构师 |
| 色块颜色 | 用户可选（预设 + 自定义） | 用户确认 + UI 设计师 |
| UI 复用 | 复用现有上传逻辑 | 用户确认 |
| 测试策略 | 先实现后测试 | 用户确认 |

---

## 核心处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        输入                                      │
│  清晰原图 (originalFile) + 模糊标注图 (annotatedFile)            │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 加载图片                                                │
│  loadImage(file) → HTMLImageElement → getImageData() → ImageData │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 尺寸对齐                                                │
│  if (尺寸不同) scaleImageData(annotatedData, originalSize)       │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: 文字区域检测 (在清晰原图上)                              │
│  detectTextRegions(originalData, textThreshold)                  │
│  → 亮度 < 阈值 的像素标记为文字                                   │
│  → 输出: boolean[] (textMask)                                    │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: 遮罩膨胀                                                │
│  expandMask(textMask, maskExpand)                                │
│  → 圆形膨胀，覆盖文字边缘抗锯齿像素                               │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 色块叠加 (在模糊标注图上)                                │
│  applyColorBlock(annotatedData, textMask, blockColor, opacity)   │
│  → 在文字区域绘制用户选择的色块                                   │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 6: 图像合成                                                │
│  compositeImages(originalData, colorBlockData, textMask)         │
│  → 文字区域: 使用清晰原图                                        │
│  → 非文字区域: 使用带色块的模糊图                                 │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        输出                                      │
│  imageDataToBlob(result) → Blob → 下载/预览                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 接口设计

### ProcessingOptions (简化版)

```typescript
export interface ProcessingOptions {
  /** 文字检测亮度阈值 (0-255) */
  textThreshold: number;      // 默认: 200
  
  /** 遮罩膨胀半径 (像素) */
  maskExpand: number;         // 默认: 2
  
  /** 色块颜色 (CSS 颜色值) */
  blockColor: string;         // 默认: '#FFFF00'
  
  /** 色块透明度 (0-1) */
  blockOpacity: number;       // 默认: 0.3
}
```

### 移除的字段

- ~~`annotationOpacity`~~ → 替换为 `blockOpacity`
- ~~`useEdgeGuidedExpand`~~ → 移除，简化架构
- ~~`edgeThreshold`~~ → 移除，简化架构

---

## 预设方案

| ID | 名称 | 阈值 | 膨胀 | 色块颜色 | 透明度 |
|----|------|------|------|----------|--------|
| `highlight-yellow` | 黄色高亮 | 200 | 2 | `#FFFF00` | 0.3 |
| `highlight-green` | 绿色高亮 | 200 | 2 | `#90EE90` | 0.35 |
| `highlight-pink` | 粉色高亮 | 200 | 2 | `#FFB6C1` | 0.35 |
| `highlight-blue` | 蓝色高亮 | 200 | 2 | `#87CEEB` | 0.3 |
| `custom` | 自定义 | 200 | 2 | 用户选择 | 用户选择 |

---

## UI 设计要点

### Sidebar 控件布局

```
┌─────────────────────────────────────┐
│  处理设置                [实时预览] │
├─────────────────────────────────────┤
│  快速预设                           │
│  [黄色] [绿色] [粉色] [蓝色]        │
├─────────────────────────────────────┤
│  ▼ 高级设置                         │
│  ┌─────────────────────────────────┐│
│  │ 亮度阈值        [====●===] 200  ││
│  │ 遮罩膨胀        [==●======] 2px ││
│  │ ─────────────────────────────── ││
│  │ 色块颜色                        ││
│  │ [●][●][●][●][●][●][+]          ││  ← 预设色 + 自定义
│  │ 当前: ■ #FFFF00                 ││
│  │ ─────────────────────────────── ││
│  │ 色块透明度      [===●====] 30%  ││
│  └─────────────────────────────────┘│
├─────────────────────────────────────┤
│  [    预览处理效果    ]             │
│  [    下载结果        ]             │
└─────────────────────────────────────┘
```

### 预设颜色

| 颜色 | HEX | 用途 |
|------|-----|------|
| 黄色 | `#FFFF00` | 经典荧光笔 |
| 绿色 | `#90EE90` | 清新标记 |
| 粉色 | `#FFB6C1` | 柔和标记 |
| 蓝色 | `#87CEEB` | 冷静专业 |
| 橙色 | `#FFA94D` | 温暖标记 |
| 紫色 | `#B197FC` | 优雅文艺 |

---

## 实施计划

### Phase 1: 核心算法重写 (优先级最高)

1. **重写 `ProcessingOptions` 接口**
   - 移除 `useEdgeGuidedExpand`、`edgeThreshold`
   - 添加 `blockColor`、`blockOpacity`

2. **实现 `applyColorBlock()` 函数**
   - 在指定遮罩区域绘制色块
   - 支持透明度混合

3. **修改 `compositeImages()` 逻辑**
   - 文字区域使用清晰原图
   - 非文字区域使用带色块的模糊图

4. **更新 `processImagePair()` 主流程**
   - 整合新的处理步骤

5. **移除 Sobel 边缘检测相关代码**
   - `sobelEdgeDetect()`
   - `edgeGuidedExpand()`

### Phase 2: UI 适配

1. **更新 Sidebar.tsx**
   - 移除边缘引导膨胀控件
   - 添加色块颜色选择器
   - 添加色块透明度滑块

2. **更新预设方案**
   - 替换为新的高亮预设

3. **调整预览视图**
   - 显示遮罩预览（可选）

### Phase 3: 优化与测试

1. **性能优化**
   - 大图片分块处理
   - 预览缩放策略

2. **错误处理**
   - 参数验证
   - 用户友好提示

3. **手动测试**
   - P0 核心功能测试
   - 边界情况测试

---

## 关键测试用例

### P0 - 必须通过

| 测试 | 描述 | 验证方法 |
|------|------|----------|
| 基础处理 | 清晰图 + 模糊图 → 合成结果 | 视觉验证 |
| 预览生成 | 实时预览正常工作 | 功能验证 |
| 尺寸适配 | 不同尺寸图片自动对齐 | 功能验证 |
| 色块显示 | 文字区域显示用户选择的色块 | 视觉验证 |

### P1 - 应该通过

| 测试 | 描述 |
|------|------|
| 批量处理 | 多对图片批量处理 |
| 下载功能 | 单张/批量下载 |
| 阈值调节 | 不同阈值效果正确 |
| 透明度调节 | 色块透明度效果正确 |

---

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 色块颜色解析 | 中 | 使用 Canvas 2D API 解析 |
| 大图片性能 | 高 | 预览缩放 + 分块处理 |
| 遮罩边缘锯齿 | 低 | 适当膨胀半径 |
| 用户理解成本 | 中 | 清晰的术语和引导 |

---

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/utils/imageProcessor.ts` | 重写 | 核心算法重构 |
| `src/components/Sidebar.tsx` | 修改 | 添加色块控件 |
| `src/App.tsx` | 修改 | 更新 options 类型 |

---

## 下一步行动

1. **确认本综合方案** - 用户审核
2. **执行 Phase 1** - 核心算法重写
3. **执行 Phase 2** - UI 适配
4. **执行 Phase 3** - 测试验证

---

**报告生成时间**: 2026-01-31
**Session ID**: WFS-image-mask-refactor
**参与角色**: system-architect, algorithm-expert, ui-designer, test-strategist
