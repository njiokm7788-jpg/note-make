{
  "project_structure": "React 应用采用分层架构：App.tsx 作为主协调器管理全局状态和预览流程，components/ 包含可复用 UI 组件（ImagePreview、Sidebar、ProcessingPanel），utils/ 包含核心图像处理逻辑（imageProcessor.ts）。预览系统采用 4 宫格布局模式，通过 generatePreview() 函数生成 4 种预览数据（original、annotated、annotationLayer、result）。",
  "relevant_files": [
    {
      "path": "src/utils/imageProcessor.ts",
      "relevance": 0.95,
      "rationale": "核心图像处理模块，包含 generatePreview() 函数返回 4 种预览数据。需要新增生成标注图添加色块后预览的函数或扩展现有返回值。"
    },
    {
      "path": "src/App.tsx",
      "relevance": 0.9,
      "rationale": "主应用组件，管理 preview 状态对象（包含 original、annotated、annotationLayer、result 四个字段），控制预览显示逻辑和对比视图切换。"
    },
    {
      "path": "src/components/ImagePreview.tsx",
      "relevance": 0.85,
      "rationale": "图像预览组件，接收 src/title/subtitle props，支持棋盘格透明背景和点击放大功能。新预览将复用此组件。"
    },
    {
      "path": "src/components/Sidebar.tsx",
      "relevance": 0.6,
      "rationale": "侧边栏组件包含色块设置（blockColor、blockOpacity），理解参数传递模式有助于确保新预览正确应用色块参数。"
    },
    {
      "path": "src/components/ProcessingPanel.tsx",
      "relevance": 0.5,
      "rationale": "处理面板组件展示参数控制模式，可参考其 UI 模式设计新预览的展示方式。"
    }
  ],
  "patterns": "1. **预览数据生成模式**: generatePreview() 返回包含 4 个 DataURL 字符串的对象 {original, annotated, annotationLayer, result}，通过 imageDataToDataURL() 转换 ImageData。\n\n2. **预览状态管理模式**: App.tsx 使用 useState<{original: string; annotated: string; annotationLayer: string; result: string} | null>(null) 管理预览状态，通过 setPreview(result) 更新。\n\n3. **预览组件复用模式**: ImagePreview 组件接收 {src, title, subtitle} props，在 4 宫格中复用：\n```tsx\n<ImagePreview src={preview.original} title=\"原始图片\" subtitle=\"清晰文字\" />\n<ImagePreview src={preview.annotated} title=\"AI标注图片\" subtitle=\"带标注\" />\n<ImagePreview src={preview.annotationLayer} title=\"提取的标注层\" subtitle=\"纯标注\" />\n<ImagePreview src={preview.result} title=\"最终结果\" subtitle=\"合成图片\" />\n```\n\n4. **色块应用模式**: applyColorBlock() 函数在非文字区域叠加色块，使用 blockColor 和 blockOpacity 参数进行 alpha 混合。\n\n5. **实时预览模式**: 使用 useDebounce hook 防抖处理选项变化，autoPreview 开启时自动触发 generatePreview()。",
  "dependencies": "内部依赖:\n- imageProcessor.ts: generatePreview(), applyColorBlock(), imageDataToDataURL(), ProcessingOptions 类型\n- ImagePreview 组件: 用于显示预览图像\n\n外部依赖:\n- React hooks: useState, useCallback, useEffect\n- Canvas API: ImageData, getContext('2d'), toDataURL()\n\n数据流: File -> loadImage() -> getImageData() -> extractTextMask() -> applyColorBlock() -> imageDataToDataURL() -> preview state -> ImagePreview 组件",
  "integration_points": "1. **generatePreview 函数扩展点** (src/utils/imageProcessor.ts:427-471)\n   - 当前返回 4 个字段，需新增 annotatedWithBlock 字段\n   - 在 line 457-463 之间添加标注图色块叠加逻辑\n\n2. **preview 状态类型扩展点** (src/App.tsx:150-155)\n   - 扩展 preview 状态类型，添加 annotatedWithBlock?: string 字段\n\n3. **对比视图渲染点** (src/App.tsx:579-584)\n   - 在 4 宫格 grid 中添加第 5 个预览项，或替换现有项\n   - 可考虑将 annotationLayer 替换为 annotatedWithBlock\n\n4. **简化视图可选扩展点** (src/App.tsx:531-566)\n   - 可在简化视图中添加切换按钮查看标注图色块效果",
  "constraints": "1. **性能约束**: generatePreview 已处理 4 张图像，新增预览需考虑处理时间，建议复用已有 scaledAnnotatedData 和 textMask。\n\n2. **UI 布局约束**: 当前对比视图使用 2x2 grid，新增预览需调整为 2x3 或 3x2 布局，或替换现有预览项。\n\n3. **状态兼容性**: preview 状态对象被多处引用，扩展字段需保持向后兼容（使用可选字段）。\n\n4. **命名约定**: 预览字段使用 camelCase（如 annotationLayer），新字段应遵循此约定。\n\n5. **色块应用逻辑**: 当前 applyColorBlock 在非文字区域叠加色块，新预览需明确是在标注图全图叠加还是仅非文字区域。",
  "clarification_needs": [
    {
      "question": "新预览应该显示在哪个位置？",
      "context": "当前对比视图有 4 个预览项（原始图片、AI标注图片、提取的标注层、最终结果），新增预览会改变布局。",
      "options": [
        "替换「提取的标注层」位置，保持 2x2 布局",
        "新增为第 5 个预览项，改为 2x3 或 3x2 布局",
        "在简化视图中添加切换按钮，不改变对比视图"
      ],
      "recommended": 0
    },
    {
      "question": "标注图色块叠加的范围是什么？",
      "context": "当前 applyColorBlock 仅在非文字区域叠加色块。新预览可以是全图叠加或仅非文字区域。",
      "options": [
        "仅在非文字区域叠加色块（与最终结果一致，但基于标注图）",
        "在标注图全图叠加半透明色块",
        "在标注图的文字区域叠加色块（高亮文字）"
      ],
      "recommended": 0
    }
  ],
  "_metadata": {
    "timestamp": "2026-02-01T12:00:00.000Z",
    "task_description": "在预览框添加标注图片添加色块后的预览 (Add preview of annotated image with color blocks in preview panel)",
    "source": "cli-explore-agent",
    "exploration_angle": "patterns",
    "exploration_index": 1,
    "total_explorations": 3,
    "duration_seconds": 45
  }
}
