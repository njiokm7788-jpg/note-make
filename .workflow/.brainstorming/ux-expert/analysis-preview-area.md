# 预览区与快捷操作交互规格

## 预览区定位

预览区是应用的核心展示区域，占据主内容区的大部分空间。它负责展示处理结果，并提供视图切换和图片查看功能。

---

## 预览区结构

### 简化视图 (默认)

```
+--------------------------------------------------+
|                                                  |
|                                                  |
|              +------------------+                |
|              |                  |                |
|              |    [结果图]      |                |
|              |                  |                |
|              +------------------+                |
|                                                  |
|         [查看对比]    [下载结果]                 |
|                                                  |
+--------------------------------------------------+
```

### 对比视图

```
+--------------------------------------------------+
|  对比视图                    [返回简化视图]       |
+-------------------------+------------------------+
|                         |                        |
|      [原始图片]         |      [AI标注图片]      |
|                         |                        |
+-------------------------+------------------------+
|                         |                        |
|    [提取的标注层]       |      [最终结果]        |
|                         |                        |
+-------------------------+------------------------+
```

---

## 简化视图 vs 对比视图切换

### 切换触发

1. **按钮点击**: "查看对比" / "返回简化视图"
2. **快捷键**: `Space` 键切换
3. **手势**: 双指捏合 (移动端)

### 切换动画

```css
/* 简化视图 -> 对比视图 */
.preview-container {
  transition: all 300ms ease-out;
}

/* 单图淡出 */
.single-preview {
  opacity: 1;
  transform: scale(1);
  transition: all 200ms ease-out;
}
.single-preview.hiding {
  opacity: 0;
  transform: scale(0.95);
}

/* 四宫格淡入 */
.grid-preview {
  opacity: 0;
  transform: scale(1.05);
  transition: all 200ms ease-out 100ms;
}
.grid-preview.showing {
  opacity: 1;
  transform: scale(1);
}
```

### 状态记忆

- 切换状态不持久化
- 每次新处理默认显示简化视图
- 用户切换后保持当前视图直到下次处理

---

## 图片放大查看

### 触发方式

1. **点击图片**: 进入放大模式
2. **双击图片**: 快速放大到 200%
3. **快捷键**: `F` 键全屏查看当前图片

### 放大模态框结构

```
+--------------------------------------------------+
| [标题]                    [-] [100%] [+]    [x]  |
+--------------------------------------------------+
|                                                  |
|                                                  |
|                  [放大的图片]                    |
|                                                  |
|                                                  |
+--------------------------------------------------+
| 滚轮缩放 · 拖拽平移 · 点击空白处关闭             |
+--------------------------------------------------+
```

### 缩放控制

**缩放范围**: 50% - 500%
**缩放步进**: 25% (按钮) / 10% (滚轮)

**缩放操作**:
- 滚轮上滚: 放大
- 滚轮下滚: 缩小
- 点击 `+`: 放大 25%
- 点击 `-`: 缩小 25%
- 双击: 切换 100% / 200%

### 平移控制

**触发条件**: 缩放 > 100% 时启用

**操作方式**:
- 鼠标拖拽
- 触摸拖拽 (移动端)
- 方向键微调

**边界限制**:
- 图片不能完全移出视口
- 弹性边界效果

### 关闭方式

1. 点击关闭按钮 `x`
2. 点击遮罩/空白区域
3. 按 `Escape` 键
4. 按 `F` 键 (切换)

---

## 下载按钮位置与行为

### 位置策略

**简化视图**:
- 位于结果图下方居中
- 与"查看对比"按钮并排

**对比视图**:
- 固定在右下角浮动
- 或位于顶部工具栏

**侧边栏**:
- 始终在侧边栏底部有一个下载按钮

### 下载行为

```typescript
async function handleDownload() {
  // 1. 显示下载中状态
  setIsDownloading(true);

  try {
    // 2. 生成最终图片 (如果需要)
    const blob = await processImagePair(originalFile, annotatedFile, options);

    // 3. 触发下载
    const filename = `${getBaseName(originalFile.name)}_merged.png`;
    saveAs(blob, filename);

    // 4. 显示成功提示
    showToast('下载成功', 'success');
  } catch (error) {
    // 5. 显示错误提示
    showToast('下载失败，请重试', 'error');
  } finally {
    setIsDownloading(false);
  }
}
```

### 下载按钮状态

**可用状态**:
- 样式: `bg-green-500 text-white`
- 图标: 下载箭头

**禁用状态** (无预览结果):
- 样式: `bg-slate-200 text-slate-400`
- 提示: "请先上传图片"

**下载中状态**:
- 样式: `bg-green-500 text-white opacity-75`
- 图标: 旋转加载
- 文字: "下载中..."

---

## 快捷操作

### Ctrl+V 粘贴图片

**行为逻辑**:
```typescript
function handlePaste(e: ClipboardEvent) {
  // 1. 检查是否在输入框中
  if (isInputFocused()) return;

  // 2. 检查是否为单张模式
  if (mode !== 'single') return;

  // 3. 提取图片文件
  const imageFile = extractImageFromClipboard(e);
  if (!imageFile) return;

  // 4. 智能分配
  e.preventDefault();
  if (!originalFile) {
    setOriginalFile(imageFile);
    showToast('已粘贴为原始图片', 'success');
  } else if (!annotatedFile) {
    setAnnotatedFile(imageFile);
    showToast('已粘贴为 AI 标注图片', 'success');
  } else {
    setOriginalFile(imageFile);
    showToast('已替换原始图片', 'info');
  }
}
```

**视觉反馈**:
- Toast 提示粘贴结果
- 状态条更新
- 如果开启实时预览，自动开始处理

### 拖拽文件到任意位置

**全局拖拽区域**:
- 整个应用窗口都可接收拖拽
- 拖拽进入时显示全屏提示层

**拖拽提示层**:
```
+--------------------------------------------------+
|                                                  |
|                                                  |
|              [上传图标]                          |
|                                                  |
|         释放以上传图片                           |
|                                                  |
|    拖到左侧 = 原图    拖到右侧 = 标注图          |
|                                                  |
|                                                  |
+--------------------------------------------------+
```

**智能分配逻辑**:
```typescript
function handleGlobalDrop(e: DragEvent) {
  const files = Array.from(e.dataTransfer.files).filter(isImageFile);

  if (files.length === 1) {
    // 单文件：智能分配
    assignFile(files[0]);
  } else if (files.length === 2) {
    // 双文件：尝试识别
    const [file1, file2] = files;
    const type1 = detectFileType(file1.name);
    const type2 = detectFileType(file2.name);

    if (type1 === 'annotated') {
      setAnnotatedFile(file1);
      setOriginalFile(file2);
    } else if (type2 === 'annotated') {
      setOriginalFile(file1);
      setAnnotatedFile(file2);
    } else {
      // 无法识别，按顺序分配
      setOriginalFile(file1);
      setAnnotatedFile(file2);
    }
  } else if (files.length > 2) {
    // 多文件：提示切换到批量模式
    showToast('检测到多个文件，建议使用批量处理模式', 'info');
  }
}
```

### 键盘快捷键列表

| 快捷键 | 功能 | 条件 | 作用域 |
|--------|------|------|--------|
| `Ctrl+V` | 粘贴图片 | 单张模式 | 全局 |
| `Escape` | 关闭模态框/抽屉 | 有打开的层 | 全局 |
| `Space` | 切换预览视图 | 有预览结果 | 预览区聚焦 |
| `Ctrl+S` | 下载结果 | 有预览结果 | 全局 |
| `Ctrl+Z` | 撤销上传 | 有已上传图片 | 全局 |
| `Ctrl+B` | 切换侧边栏 | 始终 | 全局 |
| `F` | 全屏查看图片 | 有预览结果 | 预览区聚焦 |
| `1-3` | 快速选择预设 | 始终 | 侧边栏聚焦 |
| `?` | 显示快捷键帮助 | 始终 | 全局 |

### 快捷键帮助面板

按 `?` 显示:

```
+--------------------------------------------------+
|                  键盘快捷键                       |
+--------------------------------------------------+
|                                                  |
|  Ctrl+V     粘贴图片                             |
|  Ctrl+S     下载结果                             |
|  Ctrl+B     切换侧边栏                           |
|  Ctrl+Z     撤销上传                             |
|                                                  |
|  Space      切换预览视图                         |
|  F          全屏查看                             |
|  Escape     关闭弹窗                             |
|                                                  |
|  1/2/3      快速选择预设                         |
|  ?          显示此帮助                           |
|                                                  |
+--------------------------------------------------+
|                    [关闭]                        |
+--------------------------------------------------+
```

---

## 空状态设计

### 未上传图片时

```
+--------------------------------------------------+
|                                                  |
|                                                  |
|              [空状态插图]                        |
|                                                  |
|              等待处理                            |
|                                                  |
|    请上传原始图片和AI标注图片，                  |
|    或使用 Ctrl+V 粘贴图片                        |
|                                                  |
|              [开始上传]                          |
|                                                  |
+--------------------------------------------------+
```

### 处理中状态

```
+--------------------------------------------------+
|                                                  |
|                                                  |
|              [处理动画]                          |
|                                                  |
|              正在处理...                         |
|                                                  |
|              预计剩余 2 秒                       |
|                                                  |
|                                                  |
+--------------------------------------------------+
```

### 处理失败状态

```
+--------------------------------------------------+
|                                                  |
|                                                  |
|              [错误图标]                          |
|                                                  |
|              处理失败                            |
|                                                  |
|    图片尺寸不匹配，请确保两张图片尺寸相同        |
|                                                  |
|         [重新上传]    [查看帮助]                 |
|                                                  |
+--------------------------------------------------+
```

---

## 处理进度指示

### 进度条位置

- 预览区顶部细条
- 或覆盖在图片上的半透明层

### 进度信息

```typescript
interface ProcessingProgress {
  stage: 'loading' | 'analyzing' | 'processing' | 'rendering';
  percent: number;
  message: string;
}

const stageMessages = {
  loading: '加载图片...',
  analyzing: '分析文字区域...',
  processing: '提取标注层...',
  rendering: '合成最终图片...',
};
```

### 取消处理

- 处理时间 > 3秒 显示取消按钮
- 点击取消 -> 中止处理，恢复之前状态
